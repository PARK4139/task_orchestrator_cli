#!/usr/bin/env python3
"""
ìŒì§ˆ ê°œì„  í…ŒìŠ¤íŠ¸
"""
import os
import sys
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from pkg_py.functions_split.ensure_printed import ensure_printed
from pkg_py.system_object.directories import D_PKG_IMAGE_AND_VIDEO_AND_SOUND

def test_audio_quality():
    """ìŒì§ˆ ê°œì„  í…ŒìŠ¤íŠ¸"""
    ensure_printed("ğŸµ ìŒì§ˆ ê°œì„  í…ŒìŠ¤íŠ¸", print_color="blue")
    ensure_printed("=" * 50, print_color="blue")
    
    # ê¸°ì¡´ WAV íŒŒì¼ ì°¾ê¸°
    wav_files = [f for f in os.listdir(D_PKG_IMAGE_AND_VIDEO_AND_SOUND) if f.endswith('.wav')]
    if not wav_files:
        ensure_printed("âŒ í…ŒìŠ¤íŠ¸í•  WAV íŒŒì¼ì´ ì—†ìŒ", print_color="red")
        return
    
    # ê°€ì¥ ìµœê·¼ íŒŒì¼ ì„ íƒ
    latest_wav = max(wav_files, key=lambda x: os.path.getctime(os.path.join(D_PKG_IMAGE_AND_VIDEO_AND_SOUND, x)))
    wav_path = os.path.join(D_PKG_IMAGE_AND_VIDEO_AND_SOUND, latest_wav)
    
    ensure_printed(f"ğŸ“ í…ŒìŠ¤íŠ¸ íŒŒì¼: {latest_wav}", print_color="blue")
    
    # 1. í˜„ì¬ ì˜¤ë””ì˜¤ ì •ë³´ í™•ì¸
    ensure_printed("1. í˜„ì¬ ì˜¤ë””ì˜¤ ì •ë³´ í™•ì¸...", print_color="yellow")
    try:
        from pydub import AudioSegment
        
        # ì˜¤ë””ì˜¤ ë¡œë“œ
        audio = AudioSegment.from_wav(wav_path)
        ensure_printed(f"ğŸ“Š ì˜¤ë””ì˜¤ ê¸¸ì´: {len(audio)}ms", print_color="blue")
        ensure_printed(f"ğŸ“Š ìƒ˜í”Œë ˆì´íŠ¸: {audio.frame_rate}Hz", print_color="blue")
        ensure_printed(f"ğŸ“Š ì±„ë„: {audio.channels}ê°œ", print_color="blue")
        ensure_printed(f"ğŸ“Š ìƒ˜í”Œ ë„ˆë¹„: {audio.sample_width} bytes", print_color="blue")
        
    except Exception as e:
        ensure_printed(f"âŒ ì˜¤ë””ì˜¤ ì •ë³´ í™•ì¸ ì‹¤íŒ¨: {e}", print_color="red")
    
    # 2. ê³ í’ˆì§ˆ ì˜¤ë””ì˜¤ ìƒì„± í…ŒìŠ¤íŠ¸
    ensure_printed("2. ê³ í’ˆì§ˆ ì˜¤ë””ì˜¤ ìƒì„± í…ŒìŠ¤íŠ¸...", print_color="yellow")
    try:
        from pydub import AudioSegment
        from pydub.playback import play
        
        # ì›ë³¸ ì˜¤ë””ì˜¤ ë¡œë“œ
        audio = AudioSegment.from_wav(wav_path)
        
        # ê³ í’ˆì§ˆ ì„¤ì •ìœ¼ë¡œ ë³€í™˜ (48kHz, 24bit, ìŠ¤í…Œë ˆì˜¤)
        high_quality = audio.set_frame_rate(48000).set_sample_width(3).set_channels(2)
        ensure_printed("ğŸ“ˆ ê³ í’ˆì§ˆ ë³€í™˜: 48kHz, 24bit, ìŠ¤í…Œë ˆì˜¤", print_color="blue")
        
        # ì„ì‹œ íŒŒì¼ë¡œ ì €ì¥
        temp_high_quality = wav_path.replace('.wav', '_high_quality.wav')
        high_quality.export(temp_high_quality, format="wav", parameters=[
            "-ar", "48000",  # 48kHz ìƒ˜í”Œë ˆì´íŠ¸
            "-ac", "2",      # ìŠ¤í…Œë ˆì˜¤
            "-sample_fmt", "s24"  # 24bit
        ])
        ensure_printed(f"ğŸ’¾ ê³ í’ˆì§ˆ íŒŒì¼ ì €ì¥: {os.path.basename(temp_high_quality)}", print_color="blue")
        
        # ê³ í’ˆì§ˆ ì˜¤ë””ì˜¤ ì¬ìƒ
        play(high_quality)
        ensure_printed("âœ… ê³ í’ˆì§ˆ ì˜¤ë””ì˜¤ ì¬ìƒ ì™„ë£Œ", print_color="green")
        
        # ì„ì‹œ íŒŒì¼ ì‚­ì œ
        os.remove(temp_high_quality)
        ensure_printed("ğŸ—‘ï¸ ì„ì‹œ íŒŒì¼ ì‚­ì œë¨", print_color="blue")
        
    except Exception as e:
        ensure_printed(f"âŒ ê³ í’ˆì§ˆ ì˜¤ë””ì˜¤ ìƒì„± ì‹¤íŒ¨: {e}", print_color="red")
    
    # 3. TTS ê³ í’ˆì§ˆ ì„¤ì • í…ŒìŠ¤íŠ¸
    ensure_printed("3. TTS ê³ í’ˆì§ˆ ì„¤ì • í…ŒìŠ¤íŠ¸...", print_color="yellow")
    try:
        from pkg_py.functions_split.ensure_spoken import ensure_spoken
        
        # ê³ í’ˆì§ˆ TTS ìƒì„±
        test_text = "ê³ í’ˆì§ˆ ìŒì„± í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤"
        ensure_printed(f"ğŸ“ í…ŒìŠ¤íŠ¸ í…ìŠ¤íŠ¸: '{test_text}'", print_color="blue")
        
        ensure_spoken(test_text)
        ensure_printed("âœ… ê³ í’ˆì§ˆ TTS ìƒì„± ì™„ë£Œ", print_color="green")
        
    except Exception as e:
        ensure_printed(f"âŒ ê³ í’ˆì§ˆ TTS ìƒì„± ì‹¤íŒ¨: {e}", print_color="red")
    
    ensure_printed("=" * 50, print_color="blue")
    ensure_printed("ğŸ” ìŒì§ˆ ê°œì„  í…ŒìŠ¤íŠ¸ ì™„ë£Œ", print_color="blue")

if __name__ == "__main__":
    test_audio_quality() 