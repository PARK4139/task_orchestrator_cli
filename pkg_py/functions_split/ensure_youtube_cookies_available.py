"""
YouTube ì¿ í‚¤ ìë™ ê´€ë¦¬ ì‹œìŠ¤í…œ
"""

from pkg_py.functions_split.ensure_printed import ensure_printed
from pkg_py.system_object.files import F_YOUTUBE_COOKIES_TXT
from pkg_py.functions_split.save_chrome_youtube_cookies_to_f import save_chrome_youtube_cookies_to_f
from pkg_py.functions_split.ensure_youtube_cookies_created import ensure_youtube_cookies_created, get_youtube_cookies_help
from pkg_py.functions_split.ensure_youtube_login_via_selenium import ensure_youtube_login_via_selenium, get_youtube_selenium_login_help
import os

def ensure_youtube_cookies_available():
    """
    YouTube ì¿ í‚¤ê°€ ì‚¬ìš© ê°€ëŠ¥í•œì§€ í™•ì¸í•˜ê³ , í•„ìš”ì‹œ ìë™ìœ¼ë¡œ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
    
    Returns:
        bool: ì¿ í‚¤ ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€
    """
    try:
        # 1. ì¿ í‚¤ íŒŒì¼ì´ ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
        if os.path.exists(F_YOUTUBE_COOKIES_TXT):
            file_size = os.path.getsize(F_YOUTUBE_COOKIES_TXT)
            if file_size > 100:  # íŒŒì¼ì´ ì˜ë¯¸ìˆëŠ” í¬ê¸°ì¸ì§€ í™•ì¸
                ensure_printed(f"âœ… YouTube ì¿ í‚¤ íŒŒì¼ì´ ì¡´ì¬í•©ë‹ˆë‹¤: {F_YOUTUBE_COOKIES_TXT}", print_color="green")
                ensure_printed(f"ğŸ“Š íŒŒì¼ í¬ê¸°: {file_size} bytes", print_color="cyan")
                return True
            else:
                ensure_printed(f"âš ï¸ ì¿ í‚¤ íŒŒì¼ì´ ë„ˆë¬´ ì‘ìŠµë‹ˆë‹¤: {file_size} bytes", print_color="yellow")
        
        # 2. Chromeì—ì„œ ì¿ í‚¤ ìë™ ì¶”ì¶œ ì‹œë„
        ensure_printed("ğŸª Chromeì—ì„œ YouTube ì¿ í‚¤ë¥¼ ìë™ìœ¼ë¡œ ì¶”ì¶œí•©ë‹ˆë‹¤...", print_color="cyan")
        if save_chrome_youtube_cookies_to_f():
            return True
        
        # 3. Seleniumì„ ì‚¬ìš©í•œ ìë™ ë¡œê·¸ì¸ ì‹œë„
        ensure_printed("ğŸ¤– Seleniumì„ ì‚¬ìš©í•œ YouTube ìë™ ë¡œê·¸ì¸ì„ ì‹œë„í•©ë‹ˆë‹¤...", print_color="cyan")
        if ensure_youtube_login_via_selenium():
            return True
        
        # 4. ìë™ ì¶”ì¶œ ì‹¤íŒ¨ ì‹œ ìˆ˜ë™ ìƒì„± ì•ˆë‚´
        ensure_printed("âš ï¸ ìë™ ì¿ í‚¤ ì¶”ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", print_color="yellow")
        ensure_printed("ğŸ“ ìˆ˜ë™ìœ¼ë¡œ ì¿ í‚¤ë¥¼ ìƒì„±í•˜ê² ìŠµë‹ˆë‹¤...", print_color="cyan")
        
        if ensure_youtube_cookies_created():
            get_youtube_cookies_help()
            ensure_printed("ğŸ’¡ ì¿ í‚¤ íŒŒì¼ì„ ìˆ˜ë™ìœ¼ë¡œ ìƒì„±í•œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.", print_color="yellow")
            return False  # ìˆ˜ë™ ìƒì„±ì€ ì™„ë£Œë˜ì—ˆì§€ë§Œ ì‹¤ì œ ì¿ í‚¤ëŠ” ì—†ìŒ
        
        # 4. ìµœì†Œí•œì˜ ì¿ í‚¤ íŒŒì¼ ìƒì„±
        try:
            with open(F_YOUTUBE_COOKIES_TXT, 'w', encoding='utf-8') as f:
                f.write("# Netscape HTTP Cookie File\n")
                f.write("# This file is generated by yt-dlp. Do not edit.\n\n")
                f.write("# ê¸°ë³¸ ì¿ í‚¤ í…œí”Œë¦¿ - ì‹¤ì œ ì¿ í‚¤ ê°’ìœ¼ë¡œ êµì²´ í•„ìš”\n")
                f.write(".youtube.com\tTRUE\t/\tFALSE\t1735689600\tVISITOR_INFO1_LIVE\t\n")
            ensure_printed(f"ğŸ“„ ê¸°ë³¸ ì¿ í‚¤ íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤: {F_YOUTUBE_COOKIES_TXT}", print_color="yellow")
            ensure_printed("âš ï¸ ì‹¤ì œ ì¿ í‚¤ ê°’ìœ¼ë¡œ êµì²´í•´ì•¼ í•©ë‹ˆë‹¤.", print_color="yellow")
        except Exception as e:
            ensure_printed(f"âŒ ì¿ í‚¤ íŒŒì¼ ìƒì„± ì‹¤íŒ¨: {e}", print_color="red")
        
        return False
        
    except Exception as e:
        ensure_printed(f"âŒ ì¿ í‚¤ í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}", print_color="red")
        return False

def get_youtube_cookies_status():
    """
    YouTube ì¿ í‚¤ ìƒíƒœë¥¼ í™•ì¸í•˜ëŠ” í•¨ìˆ˜
    
    Returns:
        dict: ì¿ í‚¤ ìƒíƒœ ì •ë³´
    """
    status = {
        'file_exists': False,
        'file_size': 0,
        'auto_extraction_available': False,
        'recommendation': ''
    }
    
    try:
        # íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
        if os.path.exists(F_YOUTUBE_COOKIES_TXT):
            status['file_exists'] = True
            status['file_size'] = os.path.getsize(F_YOUTUBE_COOKIES_TXT)
        
        # browser_cookie3 ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
        try:
            import browser_cookie3
            status['auto_extraction_available'] = True
        except ImportError:
            status['auto_extraction_available'] = False
        
        # ê¶Œì¥ì‚¬í•­ ì„¤ì •
        if status['file_exists'] and status['file_size'] > 100:
            status['recommendation'] = 'ready'
        elif status['auto_extraction_available']:
            status['recommendation'] = 'auto_extract'
        else:
            status['recommendation'] = 'manual_create'
        
        return status
        
    except Exception as e:
        ensure_printed(f"âŒ ì¿ í‚¤ ìƒíƒœ í™•ì¸ ì¤‘ ì˜¤ë¥˜: {e}", print_color="red")
        return status

def refresh_youtube_cookies():
    """
    YouTube ì¿ í‚¤ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ëŠ” í•¨ìˆ˜
    
    Returns:
        bool: ìƒˆë¡œê³ ì¹¨ ì„±ê³µ ì—¬ë¶€
    """
    try:
        # ê¸°ì¡´ ì¿ í‚¤ íŒŒì¼ ë°±ì—…
        if os.path.exists(F_YOUTUBE_COOKIES_TXT):
            backup_path = F_YOUTUBE_COOKIES_TXT + '.backup'
            os.rename(F_YOUTUBE_COOKIES_TXT, backup_path)
            ensure_printed(f"ğŸ“¦ ê¸°ì¡´ ì¿ í‚¤ íŒŒì¼ì„ ë°±ì—…í–ˆìŠµë‹ˆë‹¤: {backup_path}", print_color="cyan")
        
        # ìƒˆ ì¿ í‚¤ ì¶”ì¶œ
        ensure_printed("ğŸ”„ YouTube ì¿ í‚¤ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤...", print_color="cyan")
        return save_chrome_youtube_cookies_to_f()
        
    except Exception as e:
        ensure_printed(f"âŒ ì¿ í‚¤ ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨: {e}", print_color="red")
        return False

if __name__ == "__main__":
    # ì¿ í‚¤ ìƒíƒœ í™•ì¸
    status = get_youtube_cookies_status()
    ensure_printed(f"ğŸ“Š ì¿ í‚¤ ìƒíƒœ: {status}", print_color="cyan")
    
    # ì¿ í‚¤ ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
    if ensure_youtube_cookies_available():
        ensure_printed("âœ… YouTube ì¿ í‚¤ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤!", print_color="green")
    else:
        ensure_printed("âŒ YouTube ì¿ í‚¤ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.", print_color="red") 