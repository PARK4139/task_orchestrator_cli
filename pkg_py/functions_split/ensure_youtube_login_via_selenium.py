"""
Seleniumì„ ì‚¬ìš©í•œ YouTube ìë™ ë¡œê·¸ì¸ ë° ì¿ í‚¤ ì¶”ì¶œ í•¨ìˆ˜
"""

import os
import time
from pkg_py.functions_split.ensure_printed import ensure_printed
from pkg_py.system_object.files import F_YOUTUBE_COOKIES_TXT


def ensure_youtube_login_via_selenium():
    """
    Seleniumì„ ì‚¬ìš©í•´ì„œ YouTubeì— ìë™ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ê³  ì¿ í‚¤ë¥¼ ì¶”ì¶œí•˜ëŠ” í•¨ìˆ˜
    
    Returns:
        bool: ë¡œê·¸ì¸ ë° ì¿ í‚¤ ì¶”ì¶œ ì„±ê³µ ì—¬ë¶€
    """
    try:
        from selenium import webdriver
        from selenium.webdriver.chrome.options import Options
        from selenium.webdriver.common.by import By
        from selenium.webdriver.support.ui import WebDriverWait
        from selenium.webdriver.support import expected_conditions as EC
        from selenium.common.exceptions import TimeoutException, NoSuchElementException
        
        ensure_printed("ğŸ¤– Seleniumì„ ì‚¬ìš©í•œ YouTube ìë™ ë¡œê·¸ì¸ì„ ì‹œì‘í•©ë‹ˆë‹¤...", print_color="cyan")
        
        # Chrome ì˜µì…˜ ì„¤ì • (ë””ë²„ê¹… ëª¨ë“œ)
        chrome_options = Options()
        chrome_options.add_argument("--no-sandbox")
        chrome_options.add_argument("--disable-dev-shm-usage")
        chrome_options.add_argument("--disable-blink-features=AutomationControlled")
        chrome_options.add_experimental_option("excludeSwitches", ["enable-automation"])
        chrome_options.add_experimental_option('useAutomationExtension', False)
        
        # ë””ë²„ê¹…ì„ ìœ„í•œ ì¶”ê°€ ì˜µì…˜
        chrome_options.add_argument("--start-maximized")  # ë¸Œë¼ìš°ì € ìµœëŒ€í™”
        chrome_options.add_argument("--disable-web-security")  # ì›¹ ë³´ì•ˆ ë¹„í™œì„±í™”
        chrome_options.add_argument("--allow-running-insecure-content")  # ì•ˆì „í•˜ì§€ ì•Šì€ ì½˜í…ì¸  í—ˆìš©
        chrome_options.add_argument("--disable-features=VizDisplayCompositor")  # ì„±ëŠ¥ ìµœì í™”
        
        # ë¸Œë¼ìš°ì € ì‹¤í–‰
        ensure_printed("ğŸš€ Chrome ë¸Œë¼ìš°ì €ë¥¼ ì‹œì‘í•˜ëŠ” ì¤‘...", print_color="cyan")
        driver = webdriver.Chrome(options=chrome_options)
        driver.execute_script("Object.defineProperty(navigator, 'webdriver', {get: () => undefined})")
        
        # ë¸Œë¼ìš°ì € ì°½ í¬ê¸° ì„¤ì • ë° ìœ„ì¹˜ ì¡°ì •
        driver.set_window_size(1200, 800)
        driver.set_window_position(100, 100)
        ensure_printed("âœ… Chrome ë¸Œë¼ìš°ì €ê°€ ì„±ê³µì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.", print_color="green")
        
        try:
            # YouTube ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
            ensure_printed("ğŸ“± YouTube ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™ ì¤‘...", print_color="yellow")
            driver.get("https://accounts.google.com/signin/v2/identifier?service=youtube")
            ensure_printed(f"ğŸ“ í˜„ì¬ URL: {driver.current_url}", print_color="cyan")
            
            # ì‚¬ìš©ì ì…ë ¥ ëŒ€ê¸°
            ensure_printed("â³ ì‚¬ìš©ì ì…ë ¥ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...", print_color="yellow")
            ensure_printed("ğŸ’¡ ë¸Œë¼ìš°ì €ì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ë¡œê·¸ì¸ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.", print_color="cyan")
            ensure_printed("ğŸ’¡ ë¡œê·¸ì¸ì´ ì™„ë£Œë˜ë©´ Enter í‚¤ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.", print_color="cyan")
            
            # ì‚¬ìš©ì ì…ë ¥ ëŒ€ê¸°
            input("ë¡œê·¸ì¸ì´ ì™„ë£Œë˜ë©´ Enter í‚¤ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”: ")
            
            # YouTube ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì—¬ ì¿ í‚¤ í™•ì¸
            ensure_printed("ğŸ” YouTube ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™ ì¤‘...", print_color="yellow")
            driver.get("https://www.youtube.com")
            time.sleep(3)
            ensure_printed(f"ğŸ“ í˜„ì¬ URL: {driver.current_url}", print_color="cyan")
            
            # ì¿ í‚¤ ì¶”ì¶œ
            ensure_printed("ğŸª YouTube ì¿ í‚¤ë¥¼ ì¶”ì¶œí•˜ëŠ” ì¤‘...", print_color="yellow")
            cookies = driver.get_cookies()
            ensure_printed(f"ğŸ“Š ì´ ì¿ í‚¤ ê°œìˆ˜: {len(cookies)}", print_color="cyan")
            
            # YouTube ë„ë©”ì¸ ì¿ í‚¤ë§Œ í•„í„°ë§
            youtube_cookies = [c for c in cookies if '.youtube.com' in c.get('domain', '')]
            ensure_printed(f"ğŸ“Š YouTube ì¿ í‚¤ ê°œìˆ˜: {len(youtube_cookies)}", print_color="cyan")
            
            # ì¤‘ìš”í•œ ì¿ í‚¤ë“¤ í™•ì¸
            important_cookies = ['SID', 'HSID', 'SSID', 'APISID', 'SAPISID', '__Secure-1PSID', '__Secure-3PSID']
            found_cookies = [c['name'] for c in youtube_cookies if c['name'] in important_cookies]
            ensure_printed(f"ğŸ”‘ ì°¾ì€ ì¤‘ìš” ì¿ í‚¤: {found_cookies}", print_color="cyan")
            
            # Netscape í˜•ì‹ìœ¼ë¡œ ì¿ í‚¤ íŒŒì¼ ìƒì„±
            ensure_printed("ğŸ’¾ ì¿ í‚¤ íŒŒì¼ì„ ìƒì„±í•˜ëŠ” ì¤‘...", print_color="yellow")
            with open(F_YOUTUBE_COOKIES_TXT, 'w', encoding='utf-8') as f:
                f.write("# Netscape HTTP Cookie File\n")
                f.write("# This file is generated by yt-dlp. Do not edit.\n\n")
                
                saved_count = 0
                for cookie in cookies:
                    # YouTube ë„ë©”ì¸ ì¿ í‚¤ë§Œ í•„í„°ë§
                    if '.youtube.com' in cookie.get('domain', ''):
                        domain = cookie.get('domain', '')
                        path = cookie.get('path', '/')
                        secure = "TRUE" if cookie.get('secure', False) else "FALSE"
                        expires = cookie.get('expiry', 0) if cookie.get('expiry') else 0
                        name = cookie.get('name', '')
                        value = cookie.get('value', '')
                        
                        f.write(f"{domain}\tTRUE\t{path}\t{secure}\t{expires}\t{name}\t{value}\n")
                        saved_count += 1
                        ensure_printed(f"ğŸ’¾ ì¿ í‚¤ ì €ì¥: {name} = {value[:20]}{'...' if len(value) > 20 else ''}", print_color="green")
            
            ensure_printed(f"âœ… YouTube ì¿ í‚¤ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤: {F_YOUTUBE_COOKIES_TXT}", print_color="green")
            ensure_printed(f"ğŸ“Š ì €ì¥ëœ ì¿ í‚¤ ê°œìˆ˜: {saved_count}", print_color="cyan")
            
            # ë¸Œë¼ìš°ì € ë‹«ê¸° ì „ í™•ì¸
            ensure_printed("ğŸ” ë¸Œë¼ìš°ì €ë¥¼ ë‹«ê¸° ì „ì— í™•ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", print_color="yellow")
            ensure_printed("ğŸ’¡ ë¸Œë¼ìš°ì €ë¥¼ ê³„ì† ì—´ì–´ë‘ë ¤ë©´ 'n'ì„ ì…ë ¥í•˜ì„¸ìš”.", print_color="cyan")
            close_browser = input("ë¸Œë¼ìš°ì €ë¥¼ ë‹«ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ? (y/n): ").lower().strip()
            
            if close_browser == 'n':
                ensure_printed("ğŸ” ë¸Œë¼ìš°ì €ë¥¼ ì—´ì–´ë‘¡ë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ë‹«ì•„ì£¼ì„¸ìš”.", print_color="cyan")
                return True
            else:
                ensure_printed("ğŸ”’ ë¸Œë¼ìš°ì €ë¥¼ ë‹«ëŠ” ì¤‘...", print_color="yellow")
                driver.quit()
                ensure_printed("âœ… ë¸Œë¼ìš°ì €ê°€ ë‹«í˜”ìŠµë‹ˆë‹¤.", print_color="green")
            
            return True
            
        except Exception as e:
            ensure_printed(f"âŒ ë¸Œë¼ìš°ì € ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}", print_color="red")
            try:
                driver.quit()
            except:
                pass
            return False
            
    except ImportError:
        ensure_printed("âŒ Selenium ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.", print_color="red")
        ensure_printed("ğŸ’¡ ì„¤ì¹˜ ë°©ë²•: pip install selenium", print_color="yellow")
        ensure_printed("ğŸ’¡ ë˜ëŠ”: uv add selenium", print_color="yellow")
        return False
    except Exception as e:
        ensure_printed(f"âŒ YouTube ë¡œê·¸ì¸ ì‹¤íŒ¨: {e}", print_color="red")
        return False


def get_youtube_selenium_login_help():
    """
    Seleniumì„ ì‚¬ìš©í•œ YouTube ë¡œê·¸ì¸ ë„ì›€ë§ì„ ì¶œë ¥í•˜ëŠ” í•¨ìˆ˜
    """
    help_text = """
ğŸ¤– Seleniumì„ ì‚¬ìš©í•œ YouTube ìë™ ë¡œê·¸ì¸ ë°©ë²•:

1. í•¨ìˆ˜ ì‹¤í–‰: ensure_youtube_login_via_selenium()
2. Chrome ë¸Œë¼ìš°ì €ê°€ ìë™ìœ¼ë¡œ ì—´ë¦¼
3. YouTube ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
4. ìˆ˜ë™ìœ¼ë¡œ ë¡œê·¸ì¸ ì •ë³´ ì…ë ¥
5. ë¡œê·¸ì¸ ì™„ë£Œ í›„ Enter í‚¤ ì…ë ¥
6. ìë™ìœ¼ë¡œ ì¿ í‚¤ ì¶”ì¶œ ë° ì €ì¥

ğŸ’¡ ì¥ì :
- ê´€ë¦¬ì ê¶Œí•œ ë¶ˆí•„ìš”
- ì‹¤ì œ ë¸Œë¼ìš°ì € ì„¸ì…˜ ì‚¬ìš©
- ì•ˆì •ì ì¸ ì¿ í‚¤ ì¶”ì¶œ
- ìë™í™” ê°€ëŠ¥

âš ï¸ ì£¼ì˜ì‚¬í•­:
- ë¡œê·¸ì¸ ì •ë³´ëŠ” ìˆ˜ë™ ì…ë ¥ í•„ìš”
- 2ë‹¨ê³„ ì¸ì¦ì´ ì„¤ì •ëœ ê²½ìš° ì¶”ê°€ ì¸ì¦ í•„ìš”
- ë¸Œë¼ìš°ì €ê°€ ìë™ìœ¼ë¡œ ë‹«í˜
"""
    
    ensure_printed(help_text, print_color="cyan")


if __name__ == "__main__":
    ensure_youtube_login_via_selenium()
    get_youtube_selenium_login_help() 